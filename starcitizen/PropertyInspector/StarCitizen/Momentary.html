<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport"
          content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <title>Star Citizen – Momentary Button</title>

    <link rel="stylesheet" href="../sdpi.css">
    <link rel="stylesheet" href="../jquery.highlight-within-textarea.css">

    <script src="../sdtools.common.js"></script>
    <script src="../jquery-3.3.1.min.js"></script>
    <script src="../jquery.highlight-within-textarea.js"></script>

    <style>
        .no-results {
            padding: 10px;
            color: #999;
            font-style: italic;
            text-align: center;
        }
        .hidden {
            display: none !important;
        }
    .search-row {
        display: flex;
        gap: 6px;
        align-items: stretch;
        min-height: 23px;
    }
    .search-row input.sdpi-item-value {
        flex: 1;
        height: 100%;
        min-height: 23px;
        box-sizing: border-box;
    }
    </style>
</head>

<body>
<div class="sdpi-wrapper sdpi-stack">

    <div class="sdpi-section" id="section-configuration">
        <div class="sdpi-section-title">Configuration</div>

        <!-- SEARCH moved here -->
        <div class="sdpi-item">
            <div class="sdpi-item-label empty"></div>
            <div class="sdpi-item-value search-row">
                <input type="text"
                       class="sdpi-item-value"
                       id="functionSearch"
                       placeholder="Type to search functions..."
                       autocomplete="off">
                <button id="btnClearSearch" class="sdpi-clear-button hidden" onclick="clearSearch()" title="Clear search" style="margin-left:6px;padding:3px 8px;height:28px;">&times;</button>
            </div>
            <div class="sdpi-item-value"
                 id="searchResults"
                 style="font-size: 11px; color: #999; margin-top: 0;"></div>
        </div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">Function</div>
            <div class="sdpi-item-value">
                <select class="sdpi-item-value select sdProperty"
                        id="function"
                        oninput="setSettings()"
                        onchange="setSettings()">
                    <option value="" id="loadingOption">Loading Star Citizen keybinds...</option>
                </select>
            </div>
        </div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">Image delay</div>
            <div class="sdpi-item-value">
                <div style="display:flex;flex-direction:column;gap:6px;">
                    <div style="display:flex;gap:8px;align-items:center;">
                        <div style="min-width:130px;color:#d0d0d0;">Delay (ms)</div>
                        <input type="number"
                               class="sdpi-item-value sdProperty"
                               id="delay"
                               min="0"
                               oninput="setSettings()"
                               onchange="setSettings()">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="sdpi-section sdpi-section--sound" id="section-sound">
        <div class="sdpi-section-title">Sound</div>
        <div class="sdpi-item">
            <div class="sdpi-item-label empty"></div>
            <div class="sdpi-item-value">
                <div class="file-row">
                    <div class="file-main">
                        <input class="sdpi-item-value sdProperty sdFile"
                               type="file"
                               id="clickSound"
                               accept=".wav"
                               oninput="setSettings()"
                               onchange="setSettings()">
                        <label class="sdpi-file-info" id="clickSoundFilename">No file…</label>
                    </div>
                    <div class="file-actions">
                        <label class="sdpi-file-label" for="clickSound">Choose file…</label>
                        <button class="sdpi-file-button-inline hidden" id="btnClearSound" onclick="clearClickSound()">Clear</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="sdpi-section sdpi-section--details" id="section-how">
        <div class="sdpi-item" type="group">
            <div class="sdpi-item-label empty"></div>
            <div class="sdpi-item-value">
                <details style="font-size: 11px; color: #bbb; margin: 0;">
                    <summary>How it works</summary>

                    <div style="margin-top:8px;color:#ddd;line-height:1.35;">
                      <strong>Overview</strong>
                      <ul style="margin:6px 0 0 18px;padding:0;color:#ddd;">
                        <li>Momentary sends a single short press (down/up) when tapped. It does not hold the input while the Stream Deck key remains pressed — the visual "pressed" state is only confirmation feedback.</li>
                      </ul>

                      <strong style="display:block;margin-top:8px;">Images / states</strong>
                      <ul style="margin:6px 0 0 18px;padding:0;color:#ccc;">
                        <li><strong>State 0</strong> — idle/default image when no action is occurring.</li>
                        <li><strong>State 1</strong> — confirmation/active image briefly shown after the action is sent. This is visual feedback only and does not imply the input is held.</li>
                      </ul>

                      <strong style="display:block;margin-top:8px;">Timing parameters</strong>
                      <ul style="margin:6px 0 0 18px;padding:0;color:#ddd;">
                        <li><strong>Delay (ms)</strong> — how long the confirmation image (State 1) is shown after sending the short press. This controls only the visual duration and does not affect the actual input sent to the game.</li>
                      </ul>

                      <strong style="display:block;margin-top:8px;">Behavior details</strong>
                      <ul style="margin:6px 0 0 18px;padding:0;color:#ddd;">
                        <li><strong>Tap</strong> — sends a short down/up press to the game immediately and shows the confirmation image for the configured Delay.</li>

                        <li style="margin-top:6px;">Holding the Stream Deck key does not keep the input held; Momentary is intended for one-shot confirmations with a visual cue.</li>
                      </ul>

                      <strong style="display:block;margin-top:8px;">Example</strong>
                      <ul style="margin:6px 0 0 18px;padding:0;color:#ccc;">
                        <li>Delay = 100 ms. Tap the key → plugin sends a short press; the button shows the confirmation image for ~100 ms, then returns to idle.</li>
                      </ul>

                      <div style="margin-top:8px;color:#999;font-size:11px;">Tip: Use Momentary when you need a quick confirmation pulse and clear visual feedback without holding the input in-game.</div>
                    </div>

                </details>
            </div>
        </div>
    </div>

</div>

<script>
    // Dropdown state + last-known selection from payload
    let allOptions = [];
    let functionsLoaded = false;
    let savedFunctionValue = null;

    /* SAFE loadConfiguration — preserve loading text until functions arrive */
    const originalLoadConfiguration = loadConfiguration;
    loadConfiguration = function (payload) {
        // Save the function value for later (when functions are loaded)
        if (payload && payload.function !== undefined) {
            savedFunctionValue = payload.function;
        }

        // Call original but it will try to set function dropdown value
        originalLoadConfiguration(payload);

        // If functions aren't loaded yet, restore the loading text
        if (!functionsLoaded) {
            const select = document.getElementById('function');
            if (select && select.options.length === 1 && select.options[0].value === '') {
                select.options[0].textContent = 'Loading Star Citizen keybinds...';
                select.value = '';
            }
        } else if (savedFunctionValue) {
            const sel = document.getElementById('function');
            if (sel) sel.value = savedFunctionValue;
        }

        updateClearButtons();
    };

    // Populate select element from plugin-provided groups/options
    function populateDropdown(functions) {
        const select = document.getElementById('function');
        select.innerHTML = '';
        allOptions = [];

        const empty = document.createElement('option');
        empty.value = '';
        empty.textContent = '-- Select a function --';
        select.appendChild(empty);

        functions.forEach(group => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = group.label;

            group.options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.text;
                option.dataset.search = opt.searchText || opt.text.toLowerCase();

                optgroup.appendChild(option);

                allOptions.push({
                    option,
                    optgroup,
                    search: option.dataset.search
                });
            });

            select.appendChild(optgroup);
        });

        functionsLoaded = true;

        if (savedFunctionValue) {
            select.value = savedFunctionValue;
        }

        filterOptions();
    }

    // Apply search term to options + toggle helper text/no-results state
    function filterOptions() {
        if (!functionsLoaded) return;

        const term = document.getElementById('functionSearch').value.toLowerCase().trim();
        const noResults = document.getElementById('noResults');
        const searchResults = document.getElementById('searchResults');

        let visibleGroups = 0;

        allOptions.forEach(o => {
            const visible = !term || o.search.includes(term);
            o.option.style.display = visible ? '' : 'none';
        });

        document.querySelectorAll('#function optgroup').forEach(group => {
            const hasVisible = Array.from(group.children)
                .some(o => o.style.display !== 'none');

            group.style.display = hasVisible ? '' : 'none';
            if (hasVisible) visibleGroups++;
        });

        if (noResults) {
            const showNoResults = term && visibleGroups === 0;
            noResults.classList.toggle('hidden', !showNoResults);
        }

        searchResults.textContent = term
            ? `Found ${visibleGroups} group${visibleGroups !== 1 ? 's' : ''}`
            : '';
    }

    /* CLEAR SEARCH HANDLER */
    function clearSearch() {
        const input = document.getElementById('functionSearch');
        if (!input) return;
        input.value = '';
        input.focus();
        try { filterOptions(); } catch (e) { }
        updateClearSearchButton();
    }

    function updateClearSearchButton() {
        const searchInput = document.getElementById('functionSearch');
        const clearButton = document.getElementById('btnClearSearch');
        if (!clearButton || !searchInput) return;
        clearButton.classList.toggle('hidden', !searchInput.value.trim());
    }

    /* CLEAR SOUND HANDLER */
    function clearClickSound() {
        const input = document.getElementById('clickSound');
        const label = document.getElementById('clickSoundFilename');

        if (input) input.value = '';
        if (label) label.textContent = 'No file…';

        setSettings({ clickSound: '' });
        updateClearButtons();
    }

    /* CORRECT BarRaider hook — SAME AS STATIC */
    document.addEventListener('websocketCreate', function () {
        const originalOnMessage = websocket.onmessage;

        websocket.onmessage = function (evt) {
            const jsonObj = JSON.parse(evt.data);

            if (jsonObj.event === 'sendToPropertyInspector' && jsonObj.payload) {
                // Handle loading state
                if (jsonObj.payload.loading && !jsonObj.payload.functionsLoaded) {
                    const select = document.getElementById('function');
                    if (select && select.options.length <= 1) {
                        select.options[0].textContent = jsonObj.payload.message || 'Loading Star Citizen keybinds...';
                    }
                }
                // Handle functions loaded
                else if (jsonObj.payload.functionsLoaded) {
                    populateDropdown(jsonObj.payload.functions);
                }
            }

            if (originalOnMessage) {
                originalOnMessage.call(this, evt);
            }
        };
    });

    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('functionSearch')
            .addEventListener('input', function () {
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(filterOptions, 150);
                updateClearSearchButton();
            });

        document.getElementById('function')
            .addEventListener('change', function () {
                // do not auto-clear search; only update results summary
                document.getElementById('searchResults').textContent = '';
                try { filterOptions(); } catch (e) { }
            });

        const func = document.getElementById('function');
        if (func) {
            func.addEventListener('mousedown', function () { try { filterOptions(); } catch (e) { } });
            func.addEventListener('focus', function () { try { filterOptions(); } catch (e) { } });
        }

        // Ensure clear-button visibility and label update work even if shared init is skipped
        const fileInput = document.getElementById('clickSound');
        if (fileInput) {
            fileInput.addEventListener('change', function () {
                const label = document.getElementById('clickSoundFilename');
                if (label) {
                    const fileName = (this.files && this.files.length) ? this.files[0].name : (this.value || 'No file…');
                    label.textContent = fileName || 'No file…';
                }
                try { setSettings(); } catch (e) { }
                try { updateClearButtons(); } catch (e) { }
            });
        }

        try { updateClearButtons(); } catch (e) { }
        try { updateClearSearchButton(); } catch (e) { }
    });
</script>

</body>
</html>
