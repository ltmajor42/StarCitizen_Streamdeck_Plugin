<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport"
          content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <title>Star Citizen – Repeat Action</title>

    <link rel="stylesheet" href="../sdpi.css">
    <link rel="stylesheet" href="../jquery.highlight-within-textarea.css">

    <script src="../sdtools.common.js"></script>
    <script src="../jquery-3.3.1.min.js"></script>
    <script src="../jquery.highlight-within-textarea.js"></script>

    <style>
        .no-results {
            padding: 10px;
            color: #999;
            font-style: italic;
            text-align: center;
        }
        .hidden {
            display: none !important;
        }
        .note {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            line-height: 1.4;
        }
    .search-row {
        display: flex;
        gap: 6px;
        align-items: stretch;
        min-height: 23px;
    }
    .search-row input.sdpi-item-value {
        flex: 1;
        height: 100%;
        min-height: 23px;
        box-sizing: border-box;
    }
    </style>
</head>

<body>
<div class="sdpi-wrapper sdpi-stack">

    <div class="sdpi-section" id="section-configuration">
        <div class="sdpi-section-title">Configuration</div>

        <!-- SEARCH moved into Configuration -->
        <div class="sdpi-item">
            <div class="sdpi-item-label empty"></div>
            <div class="sdpi-item-value search-row">
                <input type="text"
                       class="sdpi-item-value"
                       id="functionSearch"
                       placeholder="Type to search functions..."
                       autocomplete="off">
                <button id="btnClearSearch" class="sdpi-clear-button hidden" onclick="clearSearch()" title="Clear search" style="margin-left:6px;padding:3px 8px;height:28px;">&times;</button>
            </div>
            <div class="sdpi-item-value"
                 id="searchResults"
                 style="font-size: 11px; color: #999; margin-top: 0;"></div>
        </div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">Function</div>
            <div class="sdpi-item-value">
                <select class="sdpi-item-value select sdProperty"
                        id="function"
                        oninput="setSettings()"
                        onchange="setSettings()">
                    <option value="">Loading Star Citizen keybinds...</option>
                </select>
            </div>
        </div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">Timing</div>
            <div class="sdpi-item-value">
                <div style="display:flex;flex-direction:column;gap:6px;">
                    <div style="display:flex;gap:8px;align-items:center;">
                        <div style="min-width:130px;color:#d0d0d0;">Repeat Rate (ms)</div>
                        <input type="number"
                               class="sdpi-item-value sdProperty"
                               id="repeatRate"
                               min="1"
                               oninput="setSettings()"
                               onchange="setSettings()">
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="sdpi-section sdpi-section--details" id="section-how">
        <div class="sdpi-item" type="group">
            <div class="sdpi-item-label empty"></div>
            <div class="sdpi-item-value">
                <details style="font-size: 11px; color: #bbb; margin: 0;">
                    <summary>How it works</summary>

                    <div style="margin-top:8px;color:#ddd;line-height:1.35;">
                      <strong>Overview</strong>
                      <ul style="margin:6px 0 0 18px;padding:0;color:#ddd;">
                        <li>Repeat Action continuously sends the configured function while the Stream Deck key is held. The repeat interval is controlled by the Repeat Rate setting.</li>
                      </ul>

                      <strong style="display:block;margin-top:8px;">Images / states</strong>
                      <ul style="margin:6px 0 0 18px;padding:0;color:#ccc;">
                        <li><strong>State 0</strong> — idle/default image when not repeating.</li>
                        <li><strong>State 1</strong> — active image shown while repeating (visual feedback during the hold).</li>
                      </ul>

                      <strong style="display:block;margin-top:8px;">Timing parameters</strong>
                      <ul style="margin:6px 0 0 18px;padding:0;color:#ddd;">
                        <li><strong>Repeat Rate (ms)</strong> — interval between repeated keypresses while holding the key. Set lower for faster spam and higher for slower, more deliberate repeats.</li>
                      </ul>

                      <strong style="display:block;margin-top:8px;">Behavior details</strong>
                      <ul style="margin:6px 0 0 18px;padding:0;color:#ddd;">
                        <li><strong>On press</strong> — the plugin sends an immediate keypress (down/up) for the configured function and enters the repeating loop after a short initial delay.</li>

                        <li style="margin-top:6px;"><strong>While held</strong> — the plugin sends repeated keypresses at the configured Repeat Rate until the key is released. Repeats are implemented as repeated down/up pulses to match one-shot bindings.</li>

                        <li style="margin-top:6px;"><strong>On release</strong> — the plugin stops the repeating loop and the key returns to State 0.</li>

                        <li style="margin-top:6px;">The implementation uses internal queuing and cancellation tokens to ensure repeats stop reliably when the key is released.</li>
                      </ul>

                      <strong style="display:block;margin-top:8px;">Examples</strong>
                      <ul style="margin:6px 0 0 18px;padding:0;color:#ccc;">
                        <li>Repeat Rate = 80 ms: hold the key to rapidly fire a weapon or send many consecutive inputs.</li>
                        <li>Repeat Rate = 150 ms: hold for slower, more measured repeats (useful for skills with cooldowns).</li>
                      </ul>

                      <div style="margin-top:8px;color:#999;font-size:11px;">Tip: choose a Repeat Rate that balances responsiveness with the game's ability to register inputs; very low values may be ignored by some games.</div>
                    </div>

                </details>
            </div>
        </div>
    </div>

</div>

<script>
    // Shared state for dropdown filtering
    let allOptions = [];
    let functionsLoaded = false;
    let savedFunctionValue = null;

    /* Preserve selected function if payload arrives before functions list */
    const originalLoadConfiguration = loadConfiguration;
    loadConfiguration = function (payload) {
        if (payload && payload.function !== undefined) {
            savedFunctionValue = payload.function;
        }
        originalLoadConfiguration(payload);

        // If functions aren't loaded yet, restore the loading text
        if (!functionsLoaded) {
            const select = document.getElementById('function');
            if (select && select.options.length === 1 && select.options[0].value === '') {
                select.options[0].textContent = 'Loading Star Citizen keybinds...';
                select.value = '';
            }
        } else if (savedFunctionValue) {
            const sel = document.getElementById('function');
            if (sel) sel.value = savedFunctionValue;
        }
    };

    // Populate select/optgroup structure from plugin-provided functions array
    function populateDropdown(functions) {
        const select = document.getElementById('function');
        select.innerHTML = '';
        allOptions = [];

        const empty = document.createElement('option');
        empty.value = '';
        empty.textContent = '-- Select a function --';
        select.appendChild(empty);

        functions.forEach(group => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = group.label;

            group.options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.text;
                option.dataset.search = opt.searchText || opt.text.toLowerCase();

                optgroup.appendChild(option);

                allOptions.push({
                    option,
                    optgroup,
                    search: option.dataset.search
                });
            });

            select.appendChild(optgroup);
        });

        functionsLoaded = true;

        if (savedFunctionValue) {
            select.value = savedFunctionValue;
        }

        filterOptions();
    }

    // Hide/show options + optgroups based on current search term
    function filterOptions() {
        if (!functionsLoaded) return;

        const term = document.getElementById('functionSearch').value.toLowerCase().trim();
        const noResults = document.getElementById('noResults');
        const searchResults = document.getElementById('searchResults');

        let visibleGroups = 0;

        allOptions.forEach(o => {
            const visible = !term || o.search.includes(term);
            o.option.style.display = visible ? '' : 'none';
        });

        document.querySelectorAll('#function optgroup').forEach(group => {
            const hasVisible = Array.from(group.children)
                .some(o => o.style.display !== 'none');

            group.style.display = hasVisible ? '' : 'none';
            if (hasVisible) visibleGroups++;
        });

        if (noResults) {
            const showNoResults = term && visibleGroups === 0;
            noResults.classList.toggle('hidden', !showNoResults);
        }

        searchResults.textContent = term
            ? `Found ${visibleGroups} group${visibleGroups !== 1 ? 's' : ''}`
            : '';
    }

    function clearSearch() {
        const input = document.getElementById('functionSearch');
        if (!input) return;
        input.value = '';
        input.focus();
        try { filterOptions(); } catch (e) { }
        updateClearSearchButton();
    }

    function updateClearSearchButton() {
        const searchInput = document.getElementById('functionSearch');
        const clearButton = document.getElementById('btnClearSearch');
        if (!clearButton || !searchInput) return;
        clearButton.classList.toggle('hidden', !searchInput.value.trim());
    }

    /* Hook into websocket to receive function list */
    document.addEventListener('websocketCreate', function () {
        const originalOnMessage = websocket.onmessage;

        websocket.onmessage = function (evt) {
            const jsonObj = JSON.parse(evt.data);

            if (jsonObj.event === 'sendToPropertyInspector' && jsonObj.payload) {
                // Handle loading state
                if (jsonObj.payload.loading && !jsonObj.payload.functionsLoaded) {
                    const select = document.getElementById('function');
                    if (select && select.options.length <= 1) {
                        select.options[0].textContent = jsonObj.payload.message || 'Loading Star Citizen keybinds...';
                    }
                }
                // Handle functions loaded
                else if (jsonObj.payload.functionsLoaded) {
                    populateDropdown(jsonObj.payload.functions);
                }
            }

            if (originalOnMessage) {
                originalOnMessage.call(this, evt);
            }
        };
    });

    // Debounced search + reset summary when user picks a function
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('functionSearch')
            .addEventListener('input', function () {
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(function () { filterOptions(); updateClearSearchButton(); }, 150);
            });

        document.getElementById('function')
            .addEventListener('change', function () {
                document.getElementById('functionSearch').value = '';
                document.getElementById('searchResults').textContent = '';
                try { filterOptions(); } catch (e) { }
                updateClearSearchButton();
            });

        const func = document.getElementById('function');
        if (func) {
            func.addEventListener('mousedown', function () { try { filterOptions(); } catch (e) { } });
            func.addEventListener('focus', function () { try { filterOptions(); } catch (e) { } });
        }

        // Ensure file clear buttons and search clear button visibility are correct on load
        try { updateClearButtons(); } catch (e) { }
        try { updateClearSearchButton(); } catch (e) { }
    });
</script>

</body>
</html>
