<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport"
          content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <title>Star Citizen – Dial</title>

    <link rel="stylesheet" href="../sdpi.css">
    <link rel="stylesheet" href="../jquery.highlight-within-textarea.css">

    <script src="../sdtools.common.js"></script>
    <script src="../jquery-3.3.1.min.js"></script>
    <script src="../jquery.highlight-within-textarea.js"></script>

    <style>
        .no-results { padding: 10px; color: #999; font-style: italic; text-align: center; }
        .hidden { display: none !important; }
    .search-row { display: flex; gap: 6px; align-items: stretch; min-height: 23px; }
    .search-row input.sdpi-item-value { flex: 1; height: 100%; min-height: 23px; box-sizing: border-box; }
    </style>
</head>

<body>
<div class="sdpi-wrapper sdpi-stack">

    <div class="sdpi-section sdpi-section--search" id="section-search">
        <div class="sdpi-section-title">Search</div>
        <div class="sdpi-item">
            <div class="sdpi-item-label empty"></div>
            <div class="sdpi-item-value search-row">
                <input type="text" class="sdpi-item-value" id="functionSearch" placeholder="Type to search functions..." autocomplete="off">
                <button id="btnClearSearch" class="sdpi-clear-button hidden" onclick="clearSearch()" title="Clear search" style="margin-left:6px;padding:3px 8px;height:28px;">&times;</button>
            </div>
            <div class="sdpi-item-value" id="searchResults" style="font-size: 11px; color: #999; margin-top: 0;"></div>
        </div>
    </div>

    <div class="sdpi-section" id="section-dial-config">
        <div class="sdpi-section-title">Dial Configuration</div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">Dial CW</div>
            <div class="sdpi-item-value">
                <select class="sdpi-item-value select sdProperty function-select" id="functioncw" oninput="setSettings()" onchange="setSettings()">
                    <option value="">Loading Star Citizen keybinds...</option>
                </select>
            </div>
        </div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">Dial CCW</div>
            <div class="sdpi-item-value">
                <select class="sdpi-item-value select sdProperty function-select" id="functionccw" oninput="setSettings()" onchange="setSettings()">
                    <option value="">Loading Star Citizen keybinds...</option>
                </select>
            </div>
        </div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">Dial Press</div>
            <div class="sdpi-item-value">
                <select class="sdpi-item-value select sdProperty function-select" id="functionpress" oninput="setSettings()" onchange="setSettings()">
                    <option value="">Loading Star Citizen keybinds...</option>
                </select>
            </div>
        </div>
    </div>

    <div class="sdpi-section" id="section-touch-config">
        <div class="sdpi-section-title">Touch Configuration</div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">Touch Press</div>
            <div class="sdpi-item-value">
                <select class="sdpi-item-value select sdProperty function-select" id="functiontouchpress" oninput="setSettings()" onchange="setSettings()">
                    <option value="">Loading Star Citizen keybinds...</option>
                </select>
            </div>
        </div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">Touch Longpress</div>
            <div class="sdpi-item-value">
                <select class="sdpi-item-value select sdProperty function-select" id="functiontouchlongpress" oninput="setSettings()" onchange="setSettings()">
                    <option value="">Loading Star Citizen keybinds...</option>
                </select>
            </div>
        </div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">Timing</div>
            <div class="sdpi-item-value">
                <div style="display:flex;flex-direction:column;gap:6px;">
                    <div style="display:flex;gap:8px;align-items:center;">
                        <div style="min-width:130px;color:#d0d0d0;">Delay (ms)</div>
                        <input type="number" class="sdpi-item-value sdProperty" id="delay" min="0" oninput="setSettings()" onchange="setSettings()">
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="sdpi-section sdpi-section--details" id="section-how">
        <div class="sdpi-item" type="group">
            <div class="sdpi-item-label empty"></div>
            <div class="sdpi-item-value">
                <details style="font-size: 11px; color: #bbb; margin: 0;">
                    <summary>How it works</summary>

                    <div style="margin-top:8px;color:#ddd;line-height:1.35;">
                      <strong>Overview</strong>
                      <ul style="margin:6px 0 0 18px;padding:0;color:#ddd;">
                        <li>The Dial action maps physical dial interactions (rotate, press, touch) to configured Star Citizen functions. Rotate events queue ticks; press/touch produce short key pulses or down/up pairs depending on the interaction.</li>
                      </ul>

                      <strong style="display:block;margin-top:8px;">Images / states</strong>
                      <ul style="margin:6px 0 0 18px;padding:0;color:#ccc;">
                        <li><strong>State 0</strong> — idle/default image when no activity is occurring.</li>
                        <li><strong>State 1</strong> — active/pressed image shown while a press is held or briefly used for visual feedback when sending pulses.</li>
                      </ul>

                      <strong style="display:block;margin-top:8px;">Timing parameter</strong>
                      <ul style="margin:6px 0 0 18px;padding:0;color:#ddd;">
                        <li><strong>Delay (ms)</strong> — controls the duration of the key press pulse used for rotate ticks and touch/press pulses. The code uses this value to send a short down/up pair when needed. Recommended: 10–25 ms for responsive rotate pulses; increase to 30–50 ms if the game misses short pulses.</li>
                      </ul>

                      <strong style="display:block;margin-top:8px;">Behavior details</strong>
                      <ul style="margin:6px 0 0 18px;padding:0;color:#ddd;">
                        <li><strong>Rotate (CW / CCW)</strong> — each dial tick enqueues a single keypress pulse for the configured CW/CCW function. Fast rotations queue multiple ticks but the worker drains them quickly so the dial feels responsive.</li>

                        <li style="margin-top:6px;"><strong>Dial Press</strong> — on dial down the plugin sends a key down for the configured function and sets State 1; on release the plugin sends key up and clears State 1. Use this for actions that require hold behavior.</li>

                        <li style="margin-top:6px;"><strong>Touch Press / Longpress</strong> — touch interactions send a short keypress (down then up) using the configured Delay. Longpress behaves like a longer touch interaction; mapping of long vs short press is handled by the Stream Deck hardware timing.</li>

                        <li style="margin-top:6px;"><strong>Queueing and responsiveness</strong> — the dial uses an internal queue to convert ticks into individual key pulses. Reversing direction quickly clears stale ticks for better feel.</li>
                      </ul>

                      <strong style="display:block;margin-top:8px;">Example</strong>
                      <ul style="margin:6px 0 0 18px;padding:0;color:#ccc;">
                        <li>Settings: Delay = 20 ms.</li>
                        <li>User rotates quickly 5 ticks CW → the plugin enqueues 5 pulses and sends them in rapid succession (each pulse uses a ~20 ms down/up).</li>
                        <li>User presses the dial → plugin sends key down and sets State 1 until release, then sends key up and returns to idle.</li>
                        <li>User touch-presses the dial → plugin sends a single down/up pulse using the Delay value.</li>
                      </ul>

                      <div style="margin-top:8px;color:#999;font-size:11px;">Tip: prefer small Delay values (10–25 ms) for rotation pulses; increase only if inputs are being missed in-game.</div>
                    </div>

                </details>
            </div>
        </div>
    </div>

</div>

<script>
    // In-memory state while waiting for functions list
    let allOptions = [];
    let functionsLoaded = false;
    const savedValues = { functioncw: null, functionccw: null, functionpress: null, functiontouchpress: null, functiontouchlongpress: null, delay: null };

    const originalLoadConfiguration = loadConfiguration;
    loadConfiguration = function (payload) {
        if (payload) {
            Object.keys(savedValues).forEach(key => {
                if (payload[key] !== undefined) savedValues[key] = payload[key];
            });
        }

        originalLoadConfiguration(payload);

        // If functions aren't loaded yet, restore the loading text for all function dropdowns
        if (!functionsLoaded) {
            document.querySelectorAll('.function-select').forEach(select => {
                if (select.options.length === 1 && select.options[0].value === '') {
                    select.options[0].textContent = 'Loading Star Citizen keybinds...';
                    select.value = '';
                }
            });
        } else {
            restoreSelections();
        }
    };

    function populateDropdowns(functionsData) {
        const selects = document.querySelectorAll('.function-select');
        allOptions = [];

        selects.forEach(select => {
            select.innerHTML = '';
            const empty = document.createElement('option');
            empty.value = '';
            empty.textContent = '-- Select a function --';
            select.appendChild(empty);

            (functionsData || []).forEach(group => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = group.label;

                (group.options || []).forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    option.dataset.search = (opt.searchText || opt.text || '').toLowerCase();

                    optgroup.appendChild(option);
                    allOptions.push({ option, optgroup, select, search: option.dataset.search });
                });

                select.appendChild(optgroup);
            });
        });

        functionsLoaded = true;
        restoreSelections();
        filterOptions();
    }

    function restoreSelections() {
        Object.keys(savedValues).forEach(key => {
            const el = document.getElementById(key);
            if (el && savedValues[key] !== null && savedValues[key] !== undefined) {
                el.value = savedValues[key];
            }
        });
    }

    function filterOptions() {
        if (!functionsLoaded) return;

        const term = document.getElementById('functionSearch').value.toLowerCase().trim();
        const noResults = document.getElementById('noResults');
        const searchResults = document.getElementById('searchResults');

        const visibleLabels = new Set();

        allOptions.forEach(o => {
            const visible = !term || o.search.includes(term);
            o.option.style.display = visible ? '' : 'none';
        });

        document.querySelectorAll('.function-select').forEach(select => {
            select.querySelectorAll('optgroup').forEach(group => {
                const hasVisible = Array.from(group.children).some(o => o.style.display !== 'none');
                group.style.display = hasVisible ? '' : 'none';
                if (hasVisible) visibleLabels.add(group.label);
            });
        });

        const count = visibleLabels.size;
        if (noResults) {
            const showNoResults = term && count === 0;
            noResults.classList.toggle('hidden', !showNoResults);
        }

        searchResults.textContent = term ? `Found ${count} group${count !== 1 ? 's' : ''}` : '';
    }

    function clearSearch() {
        document.getElementById('functionSearch').value = '';
        filterOptions();
        updateClearSearchButton();
    }

    function updateClearSearchButton() {
        const searchInput = document.getElementById('functionSearch');
        const clearButton = document.getElementById('btnClearSearch');
        clearButton.classList.toggle('hidden', !searchInput.value.trim());
    }

    document.addEventListener('websocketCreate', function () {
        const originalOnMessage = websocket.onmessage;
        websocket.onmessage = function (evt) {
            const jsonObj = JSON.parse(evt.data);

            if (jsonObj.event === 'sendToPropertyInspector' && jsonObj.payload) {
                // Handle loading state
                if (jsonObj.payload.loading && !jsonObj.payload.functionsLoaded) {
                    document.querySelectorAll('.function-select').forEach(select => {
                        if (select.options.length <= 1) {
                            select.options[0].textContent = jsonObj.payload.message || 'Loading Star Citizen keybinds...';
                        }
                    });
                }
                // Handle functions loaded
                else if (jsonObj.payload.functionsLoaded) {
                    populateDropdowns(jsonObj.payload.functions);
                }
            }

            if (originalOnMessage) originalOnMessage.call(this, evt);
        };
    });

    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('functionSearch').addEventListener('input', function () {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(filterOptions, 150);
            updateClearSearchButton();
        });

        document.querySelectorAll('.function-select').forEach(sel => {
            sel.addEventListener('change', function () {
                document.getElementById('functionSearch').value = '';
                document.getElementById('searchResults').textContent = '';
                try { filterOptions(); } catch (e) { }
            });

            sel.addEventListener('mousedown', function () { try { filterOptions(); } catch (e) { } });
            sel.addEventListener('focus', function () { try { filterOptions(); } catch (e) { } });
        });

        updateClearButtons();
    });
</script>

</body>
</html>
