<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport"
          content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <title>Star Citizen – Hold Macro</title>

    <link rel="stylesheet" href="../sdpi.css">
    <link rel="stylesheet" href="../jquery.highlight-within-textarea.css">

    <script src="../sdtools.common.js"></script>
    <script src="../jquery-3.3.1.min.js"></script>
    <script src="../jquery.highlight-within-textarea.js"></script>

    <style>
        .hidden {
            display: none !important;
        }
        .note {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            line-height: 1.4;
        }
    .search-row {
        display: flex;
        gap: 6px;
        align-items: stretch;
        min-height: 23px;
    }
    .search-row input.sdpi-item-value {
        flex: 1;
        height: 100%;
        min-height: 23px;
        box-sizing: border-box;
    }
    </style>
</head>

<body>
<div class="sdpi-wrapper sdpi-stack">

    <div class="sdpi-section" id="section-function">
        <div class="sdpi-section-title">Configuration</div>

        <!-- SEARCH moved into Function section -->
        <div class="sdpi-item">
            <div class="sdpi-item-label empty"></div>
            <div class="sdpi-item-value search-row">
                <input type="text"
                       class="sdpi-item-value"
                       id="functionSearch"
                       placeholder="Type to search functions..."
                       autocomplete="off">
                <button id="btnClearSearch" class="sdpi-clear-button hidden" onclick="clearSearch()" title="Clear search" style="margin-left:6px;padding:3px 8px;height:28px;">&times;</button>
            </div>
            <div class="sdpi-item-value"
                 id="searchResults"
                 style="font-size: 11px; color: #999; margin-top: 0;"></div>
        </div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">Function</div>
            <div class="sdpi-item-value">
                <select class="sdpi-item-value select sdProperty"
                        id="function"
                        oninput="setSettings()"
                        onchange="setSettings()">
                    <option value="">Loading Star Citizen keybinds...</option>
                </select>
            </div>
        </div>
    </div>

    <div class="sdpi-section sdpi-section--details" id="section-how">
        <div class="sdpi-item" type="group">
            <div class="sdpi-item-label empty"></div>
            <div class="sdpi-item-value">
                <details style="font-size: 11px; color: #bbb; margin: 0;">
                    <summary>How it works</summary>

                    <div style="margin-top:8px;color:#ddd;line-height:1.35;">
                      <strong>Overview</strong>
                      <ul style="margin:6px 0 0 18px;padding:0;color:#ddd;">
                        <li>Hold Macro sends a key/mouse/joystick down when pressed and keeps it held until you release the Stream Deck key.</li>
                      </ul>

                      <strong style="display:block;margin-top:8px;">Images / states</strong>
                      <ul style="margin:6px 0 0 18px;padding:0;color:#ccc;">
                        <li><strong>State 0</strong> — idle/default image shown when the button is not pressed.</li>
                        <li><strong>State 1</strong> — active/held image shown while the macro holds the input down.</li>
                      </ul>

                      <strong style="display:block;margin-top:8px;">Behavior details</strong>
                      <ul style="margin:6px 0 0 18px;padding:0;color:#ddd;">
                        <li><strong>On press</strong> — the plugin converts the selected function to a low-level input token and sends a key/mouse down event immediately, then switches the key to State 1. This mirrors a longpress in-game.</li>

                        <li style="margin-top:6px;"><strong>While held</strong> — the input remains held; the plugin may send repeat down events only when necessary for certain macros, but the primary behavior is a sustained down state.</li>

                        <li style="margin-top:6px;"><strong>On release</strong> — the plugin sends the corresponding key/mouse up event for the active input, clears any repeats, and returns the key to State 0.</li>

                        <li style="margin-top:6px;">If the selected function contains no valid input token (keyboard/mouse/joystick), the plugin logs a warning and no input is sent.</li>
                      </ul>

                      <strong style="display:block;margin-top:8px;">Examples</strong>
                      <ul style="margin:6px 0 0 18px;padding:0;color:#ccc;">
                        <li>Press and hold the Stream Deck key to maintain aiming/ADS; release to stop.</li>
                        <li>Use Hold Macro where the game expects a press-and-hold rather than a timed automatic release.</li>
                      </ul>

                      <div style="margin-top:8px;color:#999;font-size:11px;">Tip: prefer Hold Macro for precise manual control (longpress behavior). Use other actions if you need fixed-duration automatic releases.</div>
                    </div>

                </details>
            </div>
        </div>
    </div>

</div>

<script>
    // Dropdown cache + saved selection pulled from configuration payload
    let allOptions = [];
    let functionsLoaded = false;
    let savedFunctionValue = null;

    /* Preserve selected function if payload arrives before functions list */
    const originalLoadConfiguration = loadConfiguration;
    loadConfiguration = function (payload) {
        if (payload && payload.function !== undefined) {
            savedFunctionValue = payload.function;
        }
        originalLoadConfiguration(payload);

        // If functions aren't loaded yet, restore the loading text
        if (!functionsLoaded) {
            const select = document.getElementById('function');
            if (select && select.options.length === 1 && select.options[0].value === '') {
                select.options[0].textContent = 'Loading Star Citizen keybinds...';
                select.value = '';
            }
        } else if (savedFunctionValue) {
            const sel = document.getElementById('function');
            if (sel) sel.value = savedFunctionValue;
        }
    };

    // Build select options/optgroups from plugin-provided actions list
    function populateDropdown(functions) {
        const select = document.getElementById('function');
        select.innerHTML = '';
        allOptions = [];

        const empty = document.createElement('option');
        empty.value = '';
        empty.textContent = '-- Select a function --';
        select.appendChild(empty);

        functions.forEach(group => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = group.label;

            group.options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.text;
                option.dataset.search = opt.searchText || opt.text.toLowerCase();

                optgroup.appendChild(option);

                allOptions.push({ option, optgroup, search: option.dataset.search });
            });

            select.appendChild(optgroup);
        });

        functionsLoaded = true;

        if (savedFunctionValue) {
            select.value = savedFunctionValue;
        }

        filterOptions();
    }

    // Hide/show option rows and display no-results banner + helper text
    function filterOptions() {
        if (!functionsLoaded) return;

        const term = document.getElementById('functionSearch').value.toLowerCase().trim();
        const searchResults = document.getElementById('searchResults');

        let visibleGroups = 0;

        allOptions.forEach(o => {
            const visible = !term || o.search.includes(term);
            o.option.style.display = visible ? '' : 'none';
        });

        document.querySelectorAll('#function optgroup').forEach(group => {
            const hasVisible = Array.from(group.children)
                .some(o => o.style.display !== 'none');

            group.style.display = hasVisible ? '' : 'none';
            if (hasVisible) visibleGroups++;
        });

        searchResults.textContent = term
            ? `Found ${visibleGroups} group${visibleGroups !== 1 ? 's' : ''}`
            : '';
    }

    function clearSearch() {
        const input = document.getElementById('functionSearch');
        if (!input) return;
        input.value = '';
        input.focus();
        try { filterOptions(); } catch (e) { }
        updateClearSearchButton();
    }

    function updateClearSearchButton() {
        const searchInput = document.getElementById('functionSearch');
        const clearButton = document.getElementById('btnClearSearch');
        if (!clearButton || !searchInput) return;
        clearButton.classList.toggle('hidden', !searchInput.value.trim());
    }

    /* Hook into websocket to receive function list */
    document.addEventListener('websocketCreate', function () {
        const originalOnMessage = websocket.onmessage;

        websocket.onmessage = function (evt) {
            const jsonObj = JSON.parse(evt.data);

            if (jsonObj.event === 'sendToPropertyInspector' && jsonObj.payload) {
                // Handle loading state
                if (jsonObj.payload.loading && !jsonObj.payload.functionsLoaded) {
                    const select = document.getElementById('function');
                    if (select && select.options.length <= 1) {
                        select.options[0].textContent = jsonObj.payload.message || 'Loading Star Citizen keybinds...';
                    }
                }
                // Handle functions loaded
                else if (jsonObj.payload.functionsLoaded) {
                    populateDropdown(jsonObj.payload.functions);
                }
            }

            if (originalOnMessage) {
                originalOnMessage.call(this, evt);
            }
        };
    });

    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('functionSearch')
            .addEventListener('input', function () {
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(function () { filterOptions(); updateClearSearchButton(); }, 150);
            });

        document.getElementById('function')
            .addEventListener('change', function () {
                document.getElementById('functionSearch').value = '';
                document.getElementById('searchResults').textContent = '';
                try { filterOptions(); } catch (e) { }
                updateClearSearchButton();
            });

        const func = document.getElementById('function');
        if (func) {
            func.addEventListener('mousedown', function () { try { filterOptions(); } catch (e) { } });
            func.addEventListener('focus', function () { try { filterOptions(); } catch (e) { } });
        }
    });
</script>

</body>
</html>
