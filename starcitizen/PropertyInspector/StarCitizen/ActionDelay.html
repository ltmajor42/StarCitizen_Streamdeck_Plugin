<!-- File: PropertyInspector/StarCitizen/ActionDelay.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <title>Mhwlng's Star Citizen</title>

  <link rel="stylesheet" href="../sdpi.css">
  <link rel="stylesheet" href="../jquery.highlight-within-textarea.css">

  <script src="../sdtools.common.js"></script>
  <script src="../jquery-3.3.1.min.js"></script>
  <script src="../jquery.highlight-within-textarea.js"></script>

  <style>
    .note { font-size: 11px; color: #999; line-height: 1.4; }
    .hidden { display: none; }
    .no-results { padding: 10px; color: #999; font-style: italic; text-align: center; }
    .search-row {
        display: flex;
        gap: 6px;
        align-items: stretch;
        min-height: 23px;
    }
    .search-row input.sdpi-item-value {
        flex: 1;
        height: 100%;
        min-height: 23px;
        box-sizing: border-box;
    }
    .pi-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        padding: 14px 16px;
        margin: 0 0 12px;
        background: linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
        border: 1px solid #494949;
        border-radius: 8px;
        box-shadow: 0 10px 26px rgba(0,0,0,0.35);
    }
    .pi-title-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .pi-eyebrow {
        text-transform: uppercase;
        font-size: 10px;
        letter-spacing: 0.1em;
        color: #9ba2ad;
    }
    .pi-title {
        font-size: 16px;
        color: #ffffff;
        font-weight: 700;
    }
    .pi-subtitle {
        color: #b5b5b5;
        font-size: 11px;
        line-height: 1.4;
    }
    .pi-badge {
        background: #3f3f3f;
        color: #d6d6d6;
        border: 1px solid #575757;
        border-radius: 6px;
        padding: 6px 10px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 10px;
        white-space: nowrap;
    }
    .settings-card {
        background: #2f2f2f;
        border: 1px solid #454545;
        border-radius: 8px;
        padding: 14px 12px;
        box-shadow: 0 8px 18px rgba(0,0,0,0.35);
        margin-bottom: 12px;
    }
    .settings-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .card-title {
        font-weight: 700;
        color: #ffffff;
        font-size: 13px;
    }
    .card-subtitle {
        color: #b3b3b3;
        font-size: 11px;
        margin-top: 2px;
    }
    .settings-stack {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 10px 12px;
        align-items: start;
    }
    .settings-stack .sdpi-item,
    .settings-grid .sdpi-item {
        margin: 0;
    }
    .toggle-wrap label {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        color: #d6d6d6;
        font-weight: 700;
    }
    .footer-note {
        margin-top: 6px;
        color: #b3b3b3;
        font-size: 11px;
    }
  </style>
</head>

<body>
<div class="sdpi-wrapper">

  <div class="pi-header">
    <div class="pi-title-group">
      <div class="pi-eyebrow">Star Citizen • Action Delay</div>
      <div class="pi-title">Per-button configuration</div>
      <div class="pi-subtitle">
        Adjust how this key arms, executes, confirms, and sounds without affecting other buttons.
      </div>
    </div>
    <div class="pi-badge">Button specific</div>
  </div>

  <div class="settings-card">
    <div class="settings-card-header">
      <div>
        <div class="card-title">Function lookup</div>
        <div class="card-subtitle">Search the exported Star Citizen functions, then bind one to this key.</div>
      </div>
    </div>

    <div class="settings-stack">
      <div class="sdpi-item">
        <div class="sdpi-item-label">Search</div>
        <div class="sdpi-item-value search-row">
          <input type="text"
                 class="sdpi-item-value"
                 id="functionSearch"
                 placeholder="Type to search functions..."
                 autocomplete="off">
        </div>
        <div class="sdpi-item-value" id="searchResults"
             style="font-size: 11px; color: #999; margin-top: 4px;"></div>
      </div>

      <div class="sdpi-item">
        <div class="sdpi-item-label">Function</div>
        <select class="sdpi-item-value select sdProperty"
                id="function"
                oninput="setSettings()"
                onchange="setSettings()">
          <option value="">Loading Star Citizen functions...</option>
        </select>
      </div>

      <div class="sdpi-item no-results hidden" id="noResults">
        No functions match your search.
      </div>
    </div>
  </div>

  <div class="settings-card">
    <div class="settings-card-header">
      <div>
        <div class="card-title">Timing & behavior</div>
        <div class="card-subtitle">Tune delays, confirmation, cancellation, and feedback for this button.</div>
      </div>
    </div>

    <div class="settings-grid">
      <div class="sdpi-item">
        <div class="sdpi-item-label">Execute after (ms)</div>
        <input type="number"
               class="sdpi-item-value sdProperty"
               id="executionDelayMs"
               min="100"
               max="5000"
               step="10"
               oninput="setSettings()"
               onchange="setSettings()">
      </div>

      <div class="sdpi-item">
        <div class="sdpi-item-label">Confirm state (ms)</div>
        <input type="number"
               class="sdpi-item-value sdProperty"
               id="confirmationDurationMs"
               min="100"
               max="3000"
               step="10"
               oninput="setSettings()"
               onchange="setSettings()">
      </div>

      <div class="sdpi-item">
        <div class="sdpi-item-label">Blink rate (ms)</div>
        <input type="number"
               class="sdpi-item-value sdProperty"
               id="blinkRateMs"
               min="100"
               max="1000"
               step="10"
               oninput="setSettings()"
               onchange="setSettings()">
      </div>

      <div class="sdpi-item">
        <div class="sdpi-item-label">Tap again to cancel</div>
        <div class="sdpi-item-value toggle-wrap">
          <label for="holdToCancel">
            <input type="checkbox"
                   class="sdpi-item-value sdProperty"
                   id="holdToCancel"
                   oninput="setSettings()"
                   onchange="setSettings()">
            Enabled
          </label>
        </div>
      </div>

      <div class="sdpi-item" id="dvClickSound">
        <div class="sdpi-item-label">Sound</div>
        <div class="sdpi-item-group file">
          <input class="sdpi-item-value sdProperty sdFile"
                 type="file"
                 id="clickSound"
                 accept=".wav"
                 oninput="setSettings(); updateClearSoundVisibility();"
                 onchange="setSettings(); updateClearSoundVisibility();">
          <label class="sdpi-file-info" id="clickSoundFilename">No file...</label>
          <label class="sdpi-file-label" for="clickSound">Choose file...</label>
        </div>
      </div>

      <div class="sdpi-item hidden" id="dvClearSound">
        <div class="sdpi-item-label"></div>
        <button class="sdpi-item-value" onclick="clearClickSound()">Clear sound</button>
      </div>
    </div>

    <div class="footer-note">
      Pending blinks by toggling Stream Deck State 0 ↔ State 1. Make sure your State 0 and State 1 images are different.
    </div>
  </div>

</div>

<script>
  let allOptions = [];
  let functionsLoaded = false;
  let savedFunctionValue = null;

  const originalLoadConfiguration = loadConfiguration;
  loadConfiguration = function (payload) {
    if (payload && payload.function !== undefined) {
      savedFunctionValue = payload.function;
    }
    originalLoadConfiguration(payload);

    if (functionsLoaded && savedFunctionValue) {
      const sel = document.getElementById('function');
      if (sel && sel.value !== savedFunctionValue) {
        sel.value = savedFunctionValue;
      }
    }

    updateClearSoundVisibility();
  };

  function populateDropdown(functionsData) {
    const select = document.getElementById('function');
    select.innerHTML = '';
    allOptions = [];

    const empty = document.createElement('option');
    empty.value = '';
    empty.textContent = '-- Select a function --';
    select.appendChild(empty);

    functionsData.forEach(group => {
      const optgroup = document.createElement('optgroup');
      optgroup.label = group.label;

      group.options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.text;
        option.dataset.search = opt.searchText || opt.text.toLowerCase();

        optgroup.appendChild(option);

        allOptions.push({
          option,
          optgroup,
          search: option.dataset.search
        });
      });

      if (optgroup.children.length > 0) {
        select.appendChild(optgroup);
      }
    });

    functionsLoaded = true;

    if (savedFunctionValue) {
      select.value = savedFunctionValue;
    }

    filterOptions();
  }

  function filterOptions() {
    const term = document.getElementById('functionSearch').value.toLowerCase().trim();
    const noResults = document.getElementById('noResults');
    const searchResults = document.getElementById('searchResults');

    let visibleGroups = 0;

    allOptions.forEach(o => {
      const visible = !term || o.search.includes(term);
      o.option.style.display = visible ? '' : 'none';
    });

    document.querySelectorAll('#function optgroup').forEach(group => {
      const hasVisible = Array.from(group.children).some(o => o.style.display !== 'none');
      group.style.display = hasVisible ? '' : 'none';
      if (hasVisible) visibleGroups++;
    });

    const anyVisibleOption = allOptions.some(o => o.option.style.display !== 'none');

    noResults.classList.toggle('hidden', anyVisibleOption || !term);
    searchResults.textContent = term ? `Found ${visibleGroups} group${visibleGroups !== 1 ? 's' : ''}` : '';
  }

  function updateClearSoundVisibility() {
    const input = document.getElementById('clickSound');
    const clearBtn = document.getElementById('dvClearSound');
    if (!input || !clearBtn) return;
    clearBtn.classList.toggle('hidden', !input.value);
  }

  function clearClickSound() {
    const input = document.getElementById('clickSound');
    const label = document.getElementById('clickSoundFilename');

    if (input) input.value = '';
    if (label) label.textContent = 'No file...';

    setSettings({ clickSound: '' });
    updateClearSoundVisibility();
  }

  document.addEventListener('websocketCreate', function () {
    const originalOnMessage = websocket.onmessage;
    websocket.onmessage = function (evt) {
      const jsonObj = JSON.parse(evt.data);
      if (jsonObj.event === 'sendToPropertyInspector'
          && jsonObj.payload
          && jsonObj.payload.functionsLoaded) {
        populateDropdown(jsonObj.payload.functions);
      }
      if (originalOnMessage) {
        originalOnMessage.call(this, evt);
      }
    };
  });

  document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('functionSearch')
      .addEventListener('input', function () {
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(filterOptions, 150);
      });

    document.getElementById('function')
      .addEventListener('change', function () {
        document.getElementById('functionSearch').value = '';
        document.getElementById('searchResults').textContent = '';
      });

    updateClearSoundVisibility();
  });
</script>

</body>
</html>
