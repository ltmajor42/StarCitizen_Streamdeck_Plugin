<!-- File: PropertyInspector/StarCitizen/ActionDelay.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <title>Star Citizen – Action Delay</title>

  <link rel="stylesheet" href="../sdpi.css">
  <link rel="stylesheet" href="../jquery.highlight-within-textarea.css">

  <script src="../sdtools.common.js"></script>
  <script src="../jquery-3.3.1.min.js"></script>
  <script src="../jquery.highlight-within-textarea.js"></script>

  <style>
    .note { font-size: 11px; color: #999; line-height: 1.4; }
    .hidden { display: none !important; }
    .no-results { padding: 10px; color: #999; font-style: italic; text-align: center; }
    .search-row {
        display: flex;
        gap: 6px;
        align-items: stretch;
        min-height: 23px;
    }
    .search-row input.sdpi-item-value {
        flex: 1;
        height: 100%;
        min-height: 23px;
        box-sizing: border-box;
    }
  </style>
</head>

<body>
<div class="sdpi-wrapper sdpi-stack">

  <!-- Combined Configuration: Function + Timing -->
  <div class="sdpi-section" id="section-configuration">
    <div class="sdpi-section-title">Configuration</div>

    <!-- SEARCH moved into Configuration so it appears first -->
    <div class="sdpi-item">
      <div class="sdpi-item-label empty"></div>
      <div class="sdpi-item-value search-row">
        <input type="text"
               class="sdpi-item-value"
               id="functionSearch"
               placeholder="Type to search functions..."
               autocomplete="off">
        <button id="btnClearSearch" class="sdpi-clear-button hidden" onclick="clearSearch()" title="Clear search" style="margin-left:6px;padding:3px 8px;height:28px;">&times;</button>
      </div>
      <div class="sdpi-item-value" id="searchResults" style="font-size: 11px; color: #999; margin-top: 0;"></div>
    </div>

    <div class="sdpi-item">
      <div class="sdpi-item-label">Function</div>
      <div class="sdpi-item-value">
        <select class="sdpi-item-value select sdProperty"
                id="function"
                oninput="setSettings()"
                onchange="setSettings()">
          <option value="">Loading Star Citizen functions...</option>
        </select>
      </div>
    </div>

    <div class="sdpi-item">
      <div class="sdpi-item-label">Timing</div>
      <div class="sdpi-item-value">
        <div style="display:flex;flex-direction:column;gap:6px;">
          <div style="display:flex;gap:8px;align-items:center;">
            <div style="min-width:130px;color:#d0d0d0;">Execute after (ms)</div>
            <input type="number"
                   class="sdpi-item-value sdProperty"
                   id="executionDelayMs"
                   min="100"
                   max="5000"
                   step="10"
                   oninput="setSettings()"
                   onchange="setSettings()">
          </div>

          <div style="display:flex;gap:8px;align-items:center;">
            <div style="min-width:130px;color:#d0d0d0;">Blink rate (ms)</div>
            <input type="number"
                   class="sdpi-item-value sdProperty"
                   id="blinkRateMs"
                   min="100"
                   max="1000"
                   step="10"
                   oninput="setSettings()"
                   onchange="setSettings()">
          </div>

          <div style="display:flex;gap:8px;align-items:center;">
            <div style="min-width:130px;color:#d0d0d0;">Confirm state (ms)</div>
            <input type="number"
                   class="sdpi-item-value sdProperty"
                   id="confirmationDurationMs"
                   min="100"
                   max="3000"
                   step="10"
                   oninput="setSettings()"
                   onchange="setSettings()">
          </div>

          <div style="display:flex;gap:8px;align-items:center;">
            <div style="min-width:130px;color:#d0d0d0;">Tap again to cancel</div>
            <select id="holdToCancel" class="sdpi-item-value sdProperty" onchange="setSettings()">
              <option value="true">Enabled</option>
              <option value="false">Disabled</option>
            </select>
          </div>

        </div>
      </div>
    </div>

  </div>

  <div class="sdpi-section sdpi-section--sound" id="section-sound">
    <div class="sdpi-section-title">Sound</div>
    <div class="sdpi-item" id="dvClickSound">
      <div class="sdpi-item-label empty"></div>
      <div class="sdpi-item-value">
        <div class="file-row">
          <div class="file-main">
            <input class="sdpi-item-value sdProperty sdFile"
                   type="file"
                   id="clickSound"
                   accept=".wav"
                   oninput="setSettings()"
                   onchange="setSettings()">
            <label class="sdpi-file-info" id="clickSoundFilename">No file...</label>
          </div>
          <div class="file-actions">
            <label class="sdpi-file-label" for="clickSound">Choose file...</label>
            <button class="sdpi-file-button-inline hidden" id="btnClearSound" onclick="clearClickSound()">Clear</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="sdpi-section sdpi-section--details" id="section-how">
    <div class="sdpi-item" type="group">
      <div class="sdpi-item-label empty"></div>
      <div class="sdpi-item-value">
        <details style="font-size: 11px; color: #bbb; margin: 0;">
          <summary>How it works</summary>

          <div style="margin-top:8px;color:#ddd;line-height:1.35;">
            <strong>Overview</strong>
            <ul style="margin:6px 0 0 18px;padding:0;color:#ddd;">
              <li>The button implements an "armed → execute → confirm → idle" flow to give you a safe cancel window before the action is sent.</li>
            </ul>

            <strong style="display:block;margin-top:8px;">Images / states</strong>
            <ul style="margin:6px 0 0 18px;padding:0;color:#ccc;">
              <li><strong>State 0</strong> — idle (default) image shown when nothing is pending.</li>
              <li><strong>State 1</strong> — active/armed or confirmation image used for blinking while pending and briefly after execution.</li>
            </ul>

            <strong style="display:block;margin-top:8px;">Timing parameters</strong>
            <ul style="margin:6px 0 0 18px;padding:0;color:#ddd;">
              <li><strong>Execute after (ms)</strong> — how long the plugin waits after your tap before firing the selected function. Default in code: 800 ms. During this period the action is "armed" and can be canceled (if enabled).</li>

              <li style="margin-top:6px;"><strong>Blink rate (ms)</strong> — while the action is armed the key alternates its image between State 0 and State 1 to indicate the pending state. Set this to control how fast the key blinks (default in code: 300 ms).</li>

              <li style="margin-top:6px;"><strong>Confirm state (ms)</strong> — after the function is executed the key shows State 1 for this duration as a visual confirmation, then returns to State 0 (default in code: 500 ms).</li>
            </ul>

            <strong style="display:block;margin-top:8px;">Cancel behavior</strong>
            <ul style="margin:6px 0 0 18px;padding:0;color:#ddd;">
              <li>If <em>"Tap again to cancel"</em> is <strong>Enabled</strong>, tapping the key a second time while pending will abort the pending action. The key immediately reverts to the idle image (State 0) and <strong>no</strong> keybind or action is sent to the game.</li>
              <li>If the cancel option is <strong>Disabled</strong>, a second tap while pending is ignored and the countdown continues to completion, whereupon the action is executed.</li>
              <li>The implementation is race-safe: if a cancel and execution attempt happen at nearly the same time the plugin verifies the pending state before sending the key so canceled events are not sent.</li>
            </ul>

            <strong style="display:block;margin-top:8px;">Quick timeline example</strong>
            <ul style="margin:6px 0 0 18px;padding:0;color:#ccc;">
              <li>Settings: Execute after = 2000 ms, Blink rate = 250 ms, Confirm state = 800 ms.</li>
              <li>User taps → button enters ARMED state and begins blinking every 250 ms.</li>
              <li>If countdown reaches 2000 ms → the configured function is sent once, button shows confirm image for 800 ms, then returns to idle.</li>
              <li>If user taps again before 2000 ms while cancel is Enabled → pending is aborted immediately, button returns to idle and nothing is sent to the game.</li>
            </ul>

            <div style="margin-top:8px;color:#999;font-size:11px;">Tip: keep blink rate visibly distinct from confirmation duration so you can clearly see the pending vs confirm visual states.</div>
          </div>

        </details>
      </div>
    </div>
  </div>

</div>

<script>
  // State buckets shared across dropdown helpers
  let allOptions = [];
  let functionsLoaded = false;
  let savedFunctionValue = null;
  let savedHoldToCancel = null;

  function clearSearch() {
    const s = document.getElementById('functionSearch');
    if (!s) return;
    s.value = '';
    try { filterOptions(); } catch (e) { }
    s.focus();
    updateClearSearchButton();
  }

  function updateClearSearchButton() {
    const s = document.getElementById('functionSearch');
    const b = document.getElementById('btnClearSearch');
    if (!b || !s) return;
    b.classList.toggle('hidden', !s.value);
  }

  // loadConfiguration shim: keep selection + defer to Stream Deck default
  const originalLoadConfiguration = loadConfiguration;
  loadConfiguration = function (payload) {
    if (payload && payload.function !== undefined) {
      savedFunctionValue = payload.function;
    }
    if (payload && payload.holdToCancel !== undefined) {
      savedHoldToCancel = payload.holdToCancel;
    }

    originalLoadConfiguration(payload);

    if (functionsLoaded && savedFunctionValue) {
      const sel = document.getElementById('function');
      if (sel && sel.value !== savedFunctionValue) {
        sel.value = savedFunctionValue;
      }
    }

    // restore holdToCancel if payload provided
    const cancelEl = document.getElementById('holdToCancel');
    if (cancelEl) {
      if (savedHoldToCancel !== null && savedHoldToCancel !== undefined) {
        cancelEl.value = String(savedHoldToCancel);
      }
    }

    updateClearButtons();
  };

  // Build dropdown + optgroups from plugin payload
  function populateDropdown(functionsData) {
    const select = document.getElementById('function');
    select.innerHTML = '';
    allOptions = [];

    const empty = document.createElement('option');
    empty.value = '';
    empty.textContent = '-- Select a function --';
    select.appendChild(empty);

    functionsData.forEach(group => {
      const optgroup = document.createElement('optgroup');
      optgroup.label = group.label;

      group.options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.text;
        option.dataset.search = opt.searchText || opt.text.toLowerCase();

        optgroup.appendChild(option);

        allOptions.push({ option, optgroup, search: option.dataset.search });
      });

      if (optgroup.children.length > 0) select.appendChild(optgroup);
    });

    functionsLoaded = true;

    if (savedFunctionValue) select.value = savedFunctionValue;

    filterOptions();
    updateClearSearchButton();
  }

  // Debounced search handler keeps optgroups/summary text in sync
  function filterOptions() {
    const term = document.getElementById('functionSearch').value.toLowerCase().trim();
    const noResults = document.getElementById('noResults');
    const searchResults = document.getElementById('searchResults');

    let visibleGroups = 0;

    allOptions.forEach(o => {
      const visible = !term || o.search.includes(term);
      o.option.style.display = visible ? '' : 'none';
    });

    document.querySelectorAll('#function optgroup').forEach(group => {
      const hasVisible = Array.from(group.children).some(o => o.style.display !== 'none');
      group.style.display = hasVisible ? '' : 'none';
      if (hasVisible) visibleGroups++;
    });

    // show No results only when user searched and nothing matches
    if (noResults) {
      const showNoResults = term && visibleGroups === 0;
      noResults.classList.toggle('hidden', !showNoResults);
    }

    searchResults.textContent = term ? `Found ${visibleGroups} group${visibleGroups !== 1 ? 's' : ''}` : '';

    updateClearSearchButton();
  }

  // UI sugar: toggle visibility for the Clear button next to sound picker
  function updateClearButtons() {
    const input = document.getElementById('clickSound');
    const clearBtn = document.getElementById('btnClearSound');
    if (!input || !clearBtn) return;
    clearBtn.classList.toggle('hidden', !input.value);
  }

  // Shared sound picker helper invoked from Clear button
  function clearClickSound() {
    const input = document.getElementById('clickSound');
    const label = document.getElementById('clickSoundFilename');

    if (input) input.value = '';
    if (label) label.textContent = 'No file...';

    setSettings({ clickSound: '' });
    updateClearButtons();
  }

  // Bridge: listen for plugin messages and populate functions when ready
  document.addEventListener('websocketCreate', function () {
    const originalOnMessage = websocket.onmessage;
    websocket.onmessage = function (evt) {
      const jsonObj = JSON.parse(evt.data);
      if (jsonObj.event === 'sendToPropertyInspector'
          && jsonObj.payload
          && jsonObj.payload.functionsLoaded) {
        populateDropdown(jsonObj.payload.functions);
      }
      if (originalOnMessage) {
        originalOnMessage.call(this, evt);
      }
    };
  });

  // DOM hooks: search debounce reset + file picker housekeeping
  document.addEventListener('DOMContentLoaded', function () {
    const searchEl = document.getElementById('functionSearch');
    if (searchEl) {
      searchEl.addEventListener('input', function () {
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(filterOptions, 150);
        updateClearSearchButton();
      });
    }

    const funcEl = document.getElementById('function');
    if (funcEl) {
      // Do not clear the search on selection change; leave user's query intact until explicitly cleared
      // Ensure dropdown refreshes when opened so an empty search shows all options
      const refreshFilter = function () { try { filterOptions(); } catch (e) { } try { setTimeout(filterOptions, 10); } catch (e) { } };
      funcEl.addEventListener('mousedown', refreshFilter);
      funcEl.addEventListener('click', refreshFilter);
      funcEl.addEventListener('focus', refreshFilter);
    }

    // Ensure clear button visibility state on load
    updateClearButtons();

    // When a file is selected, update filename text and clear button visibility
    // file change handlers are initialized centrally by initSoundPickers()
  });
  </script>

</body>
</html>
